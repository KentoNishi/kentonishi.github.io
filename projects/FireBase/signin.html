<script src="https://www.gstatic.com/firebasejs/5.0.2/firebase.js"></script>
<script src="https://apis.google.com/js/platform.js" async defer></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<meta name="google-signin-client_id" content="939148943087-s9e16hsm6dhal5v0em44ndspa4bo7dcd.apps.googleusercontent.com">
<div class="g-signin2" data-onsuccess="onSignIn"></div>

<script>
  
  function onSignIn(googleUser) {
    var profile = googleUser.getBasicProfile();
    console.log('ID: ' + profile.getId());
    console.log('Name: ' + profile.getName());
    console.log('Image URL: ' + profile.getImageUrl());
    console.log('Email: ' + profile.getEmail());
    console.log('Token: '+googleUser.getAuthResponse().id_token);
    var email=profile.getEmail();
    var password=profile.getId();
    var name=profile.getName();
    alert(name);
    signIn(email,password,name);
  }
  
  var config = {
    apiKey: "AIzaSyB5XNbaaKee9GqQ74FjHPHam055_FqrVf4",
    authDomain: "kento-nishi-gi-1525841644617.firebaseapp.com",
    databaseURL: "https://kento-nishi-gi-1525841644617.firebaseio.com",
    projectId: "kento-nishi---gi-1525841644617",
    storageBucket: "kento-nishi---gi-1525841644617.appspot.com",
    messagingSenderId: "939148943087"
  };
  
  firebase.initializeApp(config);
  var auth=firebase.auth();
  
  function signIn(email, password){
    console.log(email+"-:-"+password);
    auth.signInWithEmailAndPassword(email, password).then(function(){
      profile(email.split("@")[0]);
    }).catch( function() {
       signUp(email,password,name);
    });
  }
  
  function profile(username){
    var storageRef=firebase.storage().ref("User-Data/"+username+'.txt');
    storageRef.getDownloadURL().then(function(url) {
     $.get("https://firebasestorage.googleapis.com/v0/b/kento-nishi---gi-1525841644617.appspot.com/o/User-Data%2F"+username+".txt?alt=media&token=9ab41914-8b88-4e3a-8356-5e8d53d150e4", function(data, status){
                alert("Data: " + data + "\nStatus: " + status);
        }).catch(function(error) {
          console.log("ERROR!");
          // Handle any errors
        });
      });
  }
  
  function signUp(email, password, name){
 //   console.log(email+"-:-"+password);
    auth.createUserWithEmailAndPassword(email, password).then(function(){
      var mystring = name;
      alert(mystring);
      var myblob = new Blob([mystring], {type: 'text/plain'});
      var file=myblob;
      var storageRef=firebase.storage().ref("User-Data/"+email.split("@")[0]+'.txt');
      storageRef.put(file).then(function(){location.reload();});
      console.log("Signed Up.");
    }).catch( function() {
      console.log("Sign Up Error.");
    });
  }
  
</script>

